<!DOCTYPE html>
<html lang="en">

<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
	<title>WaveSound | Main Page</title>
	<!-- font + fav icon -->
	<link rel="icon" type="image/png" href="misc/img/logo.png">
	<link href="https://fonts.googleapis.com/css?family=Roboto" rel="stylesheet">
	<link href="https://fonts.googleapis.com/css?family=Pacifico" rel="stylesheet">
	<!-- style -->
	<link rel="stylesheet" type="text/css" href="misc/css/style.css" /> </head>

<body>
	<header>
		<?php
			include("misc/include/header.html");
			$_SESSION["current-page"]="Listen";
		?>
	</header>
	<nav>
		<?php
			include("misc/include/navigation.html");
		?>
	</nav>
	<main class="main-right-listen">
		<div class="content-body">
			<div class="content">
				<div class="content-play">
					<div class="content">
					
					
						<?php
							if(isset($_GET['id_song'])){
								$id_song = $_GET['id_song'];
								require ('misc/php/connection.php');
								require ('misc/php/tools.php');
								$statement=select("SELECT * FROM song WHERE id_song='$id_song'");
								$col = count($statement);
								$row = $statement[0];
								$userID= $_SESSION["userID"];
							}
						?>	
						
						<div class="center">
						<div id="player-audio">
							<div class="content-card-cover" src="misc/img/album-covers/default.png">
								<?php
									$getAlbum=select("SELECT * FROM album WHERE id_album='$row[5]'");
									echo '<img id="cover-player" src="/misc/img/album-covers/'.$getAlbum[0][2].'" alt="cover" /> ';
								?>
							</div>
								<audio controls>
									<?php echo '<source src="misc/songs/'.$row[4].'" type="audio/mpeg">';?> Your browser does not support the audio element.
								</audio>
							</div>
						</div>
						
						<div id="info-player">
							<form id="like-dislike" action="misc/php/player.php" method="post">
								<?php echo '<input type="hidden" value="'.$id_song.'" name="id_song">';?>
								<div class="submit-like-dislike like">
									<?php
										if(alreadyVoted($userID,$id_song, 'like'))
											echo '<input id="voted-like" type="submit" value="like" name="like" title="voted like">';
										else
											echo '<input type="submit" value="like" name="like" title="vote like">';
									?>
								</div>
								<?php echo getLikes($id_song);?>
								<div class="submit-like-dislike dislike">
									<?php
										if(alreadyVoted($userID,$id_song, 'dislike'))
											echo '<input id="voted-dislike" type="submit" value="dislike" name="dislike" title="voted dislike">';
										else
											echo '<input type="submit" value="dislike" name="dislike" title="vote dislike">';
									?>
								</div>
								<?php echo getDislikes($id_song);?>
							</form>
							<?php
								echo '<h1>'.$row[1].'</h1>';
								echo '<div>';
								echo 'Upload date: '.date_format(date_create($row[6]),"d/m/Y");
								echo '</div>';
								echo '<div>';
								echo 'Description: '.$row[3];
								echo '</div>';
							?>
						</div>
						<h3>Leave a comment</h3>
						<form action="misc/php/player.php" method="post">
							<div>
								<textarea rows="20" id="comment-area" type="text" name="yourComment" placeholder="Write your comment on this track" required></textarea>
								<?php echo '<input type="hidden" value="'.$id_song.'" name="id_song">'; ?>
							</div>
							<div>
								<input type="submit" value="comment" name="comment">
							</div>
						</form>
						
						<div id="comments">
						<?php
						
						$getComments=select("SELECT * FROM comment WHERE id_song='$id_song'");
						$num_comments = count($getComments);
						
						if($num_comments==1){
							echo "1 comment";
						}else{
							echo $num_comments." comments";
						}
							
						for($i=$num_comments-1; $i>=0; $i--){
							$comment = $getComments[$i];
							$getUser=select("SELECT username,avatar,u_id FROM user WHERE u_id='$comment[2]'");
							
							echo '<div class="comment">';
							echo '<div class="user-comment"><img id="profile-pic" src="misc/img/users/'.$getUser[0][1].'" />';
							echo "<h3>".$getUser[0][0]."</h3></div>";
							echo '<h4>'.$comment[1].'</h4>';
							
							echo '<form action="misc/php/player.php" method="post">';
							echo '<input type="hidden" value="'.$comment[0].'" name="idOfComment">';
							echo '<input type="hidden" value="'.$id_song.'" name="id_song">';
							
							$userComment = $getUser[0][2];
							if($userComment==$userID)
								echo '<input type="submit" value="delete" name="delete">';
							else
								echo '<input type="submit" value="report" name="report">';
							echo '</form>';
							echo '</div>';
						}
						
						?>
						</div>
					</div>
				</div><!--
				--><div class="content-suggestion center">
					<div class="content-card-container">
					<div>10 newest songs</div>
						<div class="content-card">
							<?php
						$getNewSongs = select("SELECT id_album,id_song,title FROM song ORDER BY upload_date DESC LIMIT 10;");
						
						for($i=0; $i<count($getNewSongs);$i++){
							$toString = $getNewSongs[$i][0];
							$getAlbumIMG = select("SELECT picture FROM album WHERE id_album='$toString[0]';");
							$stringa = $getAlbumIMG[0];
							echo '<a href="listen.html?id_song='.$getNewSongs[$i][1].'">';
							echo $getNewSongs[$i][2];
							echo '<div class="card-suggestion"><img src="misc/img/album-covers/'.$stringa[0].'" /></div>';
							echo '</a>';
						}
						?>
						</div>
					</div>
					</div>
			</div>
		</div>
	</main>
	<footer class="footer-main">
		<?php
			include("misc/include/footer.html");
		?>
	</footer>
	<button onclick="topFunction()" id="button-top" title="Go to top">Top</button>
	<script src="misc/js/button-top.js"></script>
</body>

</html>
