<!DOCTYPE html>
<html lang="en">

<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
	<title>WaveSound | Search Music</title>
	<!-- font + fav icon -->
	<link rel="icon" type="image/png" href="misc/img/logo.png">
	<link href="https://fonts.googleapis.com/css?family=Roboto" rel="stylesheet">
	<link href="https://fonts.googleapis.com/css?family=Pacifico" rel="stylesheet">
	<!-- style -->
	<link rel="stylesheet" type="text/css" href="misc/css/style.css" /> </head>

<body>
	<header>
		<?php
			include("misc/include/header.html");
			$_SESSION["current-page"]="Search Music";
		?>
	</header>
	<nav>
		<?php
			include("misc/include/navigation.html");
		?>
	</nav>
	<main class="main-right">
		<div class="content-body">
			<div class="content">
				<h1>Search Music</h1>
				<h2>Search by name</h2>
				<form class="search-bar" action="search-music.html" method="post">
					<input type="text" placeholder="Search.." name="search">
					<button type="submit"></button>
				</form>
				<h2>Search by genre</h2>
				<form action="search-music.html" method="post">
					<div class="search-by-genre"> <span class="select">
						Select genre
						<select name="genre">
							<option>---</option>
						   <?php
						   require('misc/php/tools.php');
								$getGenre= select("SELECT name FROM genre;");
								  for($i=0;$i<count($getGenre);$i++){
										$nomeGenere = $getGenre[0][0];
										echo '<option value="'.$nomeGenere.'"><'.$nomeGenere.'</option>';
								  }
						   ?>
						</select>
					</span> <span class="select">
						Sort by
						<select name="sort">
							<option>---</option>
							<option value="upload_date">Date</option>
							<option value="rating">Rating</option>
							<option value="download">Downloads</option>
						</select>
					</span> <span class="select">
						Order
						<select name="order">
							<option>---</option>
							<option value="descending">Descending</option>
							<option value="ascending">Ascending</option>
						</select>
					</span>
						<button class="select">Search</button>
					</div>
				</form>
				<br/>
				<h3>Results:</h3>

				<?php

if (isset($_POST['search'])) {
	$keyword = $_POST['search'];
	$query   = select("SELECT title,name,upload_date FROM song,genre WHERE genre=id_genre AND title LIKE '%$keyword%'");

	echo 'Titolo:';

	echo "<table>";
	echo "<tr>
		<th>Titolo</th>
		<th>Genre</th>
		<th>Upload Date</th>
	</tr>";

	for ($i = 0; $i < count($query); $i++) {
		$title       = $query[$i][0];
		$genre       = $query[$i][1];
		$upload_date = $query[$i][2];

		echo "<tr><td>" . $title . "</td>
						<td>" . $genre . "</td>
						  <td>" . $upload_date . "</td>
					  </tr>";

	}
	echo "</table>";

	$query2 = select("SELECT username,name,surname FROM user WHERE username LIKE '%$keyword%' OR name LIKE '%$keyword%' OR surname LIKE '%$keyword%'");


	echo 'Autore:';

	echo "<table>";
	echo "<tr><th>Username</th>
						<th>Name</th>
						  <th>Surname</th>
					</tr>";

	for ($i = 0; $i < count($query2); $i++) {
		$username = $query2[$i][0];
		$name     = $query2[$i][1];
		$surname  = $query2[$i][2];

		echo "<tr><td>" . $username . "</td>
						<td>" . $name . "</td>
						  <td>" . $surname . "</td>
					  </tr>";

	}
	echo "</table>";

	$query3 = select("SELECT name FROM album WHERE name LIKE '%$keyword%' ");

	echo 'Album:';
	echo "<table>";
	echo "<tr>
						<th>Name</th>
					</tr>";
	for ($i = 0; $i < count($query3); $i++) {
		$name = $query3[$i][0];

		echo "<tr>
						<td>" . $name . "</td>
					  </tr>";
	}
	echo "</table>";
}
if (isset($_POST['order'])) {
	$order = $_POST['order'];
	if ($order == "descending") {
		$genre  = $_POST['genre'];
		$sort   = $_POST['sort'];
		//$period = $_POST['period'];
		$order  = $_POST['order'];
		$apice  = '"';
		$genre2 = $apice . $genre . $apice;

		echo $genre2;
		$query  = 'SELECT  title,name AS genre,upload_date,download FROM song,genre WHERE genre=id_genre AND name=' . $genre2 . ' ORDER BY ' . $sort . ' DESC ';
		$result = $connection->prepare($query);
		$result->execute();

		while ($row = $result->fetch(PDO::FETCH_ASSOC)) {
			$title       = $row['title'];
			$genre       = $row['genre'];
			$upload_date = $row['upload_date'];

			echo "<table>";
			echo "<tr><th>Titolo</th>
				  <th>Genre</th>
				  <th>Upload Date</th>
				</tr>";
			echo "<tr><td>" . $title . "</td>
				  <td>" . $genre . "</td>
				  <td>" . $upload_date . "</td>
				  </tr>";
			echo "</table>";
		}
	}

	if ($order == "ascending") {
		$genre  = $_POST['genre'];
		$sort   = $_POST['sort'];
		//$period = $_POST['period'];
		$order  = $_POST['order'];
		$apice  = '"';
		$genre2 = $apice . $genre . $apice;

		echo $genre2;
		$query  = 'SELECT title,name AS genre,upload_date,download FROM song,genre WHERE genre=id_genre AND name=' . $genre2 . ' ORDER BY ' . $sort . ' ASC ';
		$result = $connection->prepare($query);
		$result->execute();

		while ($row = $result->fetch(PDO::FETCH_ASSOC)) {
			$title       = $row['title'];
			$genre       = $row['genre'];
			$upload_date = $row['upload_date'];

			echo "<table>";
			echo "<tr><th>Titolo</th>
				  <th>Genre</th>
				  <th>Upload Date</th>
				  </tr>";
			echo "<tr><td>" . $title . "</td>
				  <td>" . $genre . "</td>
				  <td>" . $upload_date . "</td>
				  </tr>";
			echo "</table>";
		}
	}
}
?>

					<!--<div class="content-card">
							<?php
						$getNewSongs = select("SELECT id_album,id_song,title FROM song ORDER BY upload_date DESC LIMIT 10;");

						for($i=0; $i<count($getNewSongs);$i++){
							$toString = $getNewSongs[$i][0];
							$getAlbumIMG = select("SELECT picture FROM album WHERE id_album='$toString[0]';");
							$stringa = $getAlbumIMG[0];
							echo '<a href="listen.html?id_song='.$getNewSongs[$i][1].'">';
							echo $getNewSongs[$i][2];
							echo '<div class="card-suggestion"><img src="misc/img/album-covers/'.$stringa[0].'" /></div>';
							echo '</a>';
						}
						?>
						</div>
					</div>-->


			</div>
		</div>
	</main>
	<footer class="footer-main">
		<?php
			include("misc/include/footer.html");
		?>
	</footer>
	<button onclick="topFunction()" id="button-top" title="Go to top">Top</button>
	<script src="misc/js/button-top.js"></script>
</body>

</html>
