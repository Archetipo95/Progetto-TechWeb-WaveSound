<!DOCTYPE html>
<html lang="en">

<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
	<title>WaveSound | Search Music</title>
	<!-- font + fav icon -->
	<link rel="icon" type="image/png" href="misc/img/logo.png">
	<link href="https://fonts.googleapis.com/css?family=Roboto" rel="stylesheet">
	<link href="https://fonts.googleapis.com/css?family=Pacifico" rel="stylesheet">
	<!-- style -->
	<link rel="stylesheet" type="text/css" href="misc/css/style.css" /> </head>

<body>
	<header>
		<?php
			include("misc/include/header.html");
			$_SESSION["current-page"]="Search Music";
		?>
	</header>
	<nav>
		<?php
			include("misc/include/navigation.html");
		?>
	</nav>
	<main class="main-right">
		<div class="content-body">
			<div class="content">
				<h1>Search Music</h1>
				<h2>Search by name</h2>
				<form class="search-bar" action="search-music.html" method="post">
					<input type="text" placeholder="Search.." name="search">
					<button type="submit"></button>
				</form>
				<h2>Search by genre</h2>
				<form action="search-music.html" method="post">
					<div class="search-by-genre"> <span class="select">
						Select genre
						<select name="genre">
							<option>---</option>
						   <?php
						   require('misc/php/tools.php');
								$getGenre= select("SELECT name FROM genre;");
								  for($i=0;$i<count($getGenre);$i++){
										$nomeGenere = $getGenre[0][0];
										echo '<option value="'.$nomeGenere.'"><'.$nomeGenere.'</option>';
								  }
						   ?>
						</select>
					</span> <span class="select">
						Sort by
						<select name="sort">
							<option>---</option>
							<option value="upload_date">Date</option>
							<option value="rating">Rating</option>
							<option value="download">Downloads</option>
						</select>
					</span> <span class="select">
						Order
						<select name="order">
							<option>---</option>
							<option value="descending">Descending</option>
							<option value="ascending">Ascending</option>
						</select>
					</span>
						<button class="select">Search</button>
					</div>
				</form>
				<br/>
				<h3>Results:</h3>

<?php
if (isset($_POST['search'])) {
	$keyword = $_POST['search'];
	$query = select("SELECT title,name,upload_date,song.id_song,id_album FROM song,genre WHERE genre=id_genre AND title LIKE '%$keyword%'");

	if(count($query)>0){
	echo 'Search results from title:';
	echo '<div class="center">';
	echo '<div class="results-container">';
	for ($i = 0;$i < count($query);$i++) {
		$title = $query[$i][0];
		//$genre = $query[$i][1];
		//$upload_date = $query[$i][2];
		$song = $query[$i][3];
		$album = $query[$i][4];
		$getAlbumIMG = select("SELECT picture FROM album WHERE id_album='$album';");
		$pathPicture = $getAlbumIMG[0][0];

		echo '<a href="listen.html?id_song=' . $song . '">';
		echo '<div class="result-card">';

		echo '<img src="misc/img/album-covers/' . $pathPicture . '" />';
		echo '<div class="result-card-title">'.$query[$i][0].'</div>';

		echo '</a>';
		echo '</div>';

	}
	echo '<div class="spacer" style="clear: both;"></div></div>';
	echo '</div>';
}
	$query2 = select("SELECT username,name,surname,avatar,u_id FROM user WHERE username LIKE '%$keyword%' OR name LIKE '%$keyword%' OR surname LIKE '%$keyword%'");
if(count($query2)>0){
	echo 'Search results from autor:';
	echo '<div class="center">';
	echo '<div class="results-container">';

	for ($i = 0;$i < count($query2);$i++) {
		$username = $query2[$i][0];
		$name = $query2[$i][1];
		$surname = $query2[$i][2];
		$avatar = $query2[$i][3];
		$userID = $query2[$i][4];

		echo '<a href="user.html?userID='.$userID.'">';
		echo '<div class="result-card">';
		echo '<div class="result-card-title">'.$username.'</div>';
		echo '<img src="misc/img/users/' . $avatar . '" />';
		echo '<div class="result-card-title-sub">'.$name.'</div>';
		echo '<div class="result-card-title-sub">'.$surname.'</div>';

		echo '</a>';
		echo '</div>';

	}
	echo '<div class="spacer" style="clear: both;"></div></div>';
	echo '</div>';
}
	$query3 = select("SELECT * FROM album WHERE name LIKE '%$keyword%' ");
if(count($query3)>0){
	echo 'Search results from album:';
	echo '<div class="center">';
	echo '<div class="results-container">';
	for ($i = 0;$i < count($query3);$i++) {
		$idAlbum = $query3[$i][0];
		$name = $query3[$i][1];
		$picture = $query3[$i][2];

		//echo '<a href="user.html?userID='.$userID.'">';
		echo '<div class="result-card">';
		echo '<img src="misc/img/album-covers/' . $picture . '" />';
		echo '<div class="result-card-title">'.$name.'</div>';
		//echo '</a>';
		echo '</div>';

	}
	echo '<div class="spacer" style="clear: both;"></div></div>';
	echo '</div>';
}


}

if (isset($_POST['order'])) {
	$order = $_POST['order'];
	if ($order == "descending") {
		$genre = $_POST['genre'];
		$sort = $_POST['sort'];
		//$period = $_POST['period'];
		$order = $_POST['order'];
		$apice = '"';
		$genre2 = $apice . $genre . $apice;

		echo $genre2;
		$query = 'SELECT  title,name AS genre,upload_date,download FROM song,genre WHERE genre=id_genre AND name=' . $genre2 . ' ORDER BY ' . $sort . ' DESC ';
		$result = $connection->prepare($query);
		$result->execute();

		while ($row = $result->fetch(PDO::FETCH_ASSOC)) {
			$title = $row['title'];
			$genre = $row['genre'];
			$upload_date = $row['upload_date'];

			echo "<table>";
			echo "<tr><th>Titolo</th>
				  <th>Genre</th>
				  <th>Upload Date</th>
				</tr>";
			echo "<tr><td>" . $title . "</td>
				  <td>" . $genre . "</td>
				  <td>" . $upload_date . "</td>
				  </tr>";
			echo "</table>";
		}
	}

	if ($order == "ascending") {
		$genre = $_POST['genre'];
		$sort = $_POST['sort'];
		//$period = $_POST['period'];
		$order = $_POST['order'];
		$apice = '"';
		$genre2 = $apice . $genre . $apice;

		echo $genre2;
		$query = 'SELECT title,name AS genre,upload_date,download FROM song,genre WHERE genre=id_genre AND name=' . $genre2 . ' ORDER BY ' . $sort . ' ASC ';
		$result = $connection->prepare($query);
		$result->execute();

		while ($row = $result->fetch(PDO::FETCH_ASSOC)) {
			$title = $row['title'];
			$genre = $row['genre'];
			$upload_date = $row['upload_date'];

			echo "<table>";
			echo "<tr><th>Titolo</th>
				  <th>Genre</th>
				  <th>Upload Date</th>
				  </tr>";
			echo "<tr><td>" . $title . "</td>
				  <td>" . $genre . "</td>
				  <td>" . $upload_date . "</td>
				  </tr>";
			echo "</table>";
		}
	}
}
?>


					<!--<div class="content-card">
							<?php
						$getNewSongs = select("SELECT id_album,id_song,title FROM song ORDER BY upload_date DESC LIMIT 10;");

						for($i=0; $i<count($getNewSongs);$i++){
							$toString = $getNewSongs[$i][0];
							$getAlbumIMG = select("SELECT picture FROM album WHERE id_album='$toString[0]';");
							$stringa = $getAlbumIMG[0];
							echo '<a href="listen.html?id_song='.$getNewSongs[$i][1].'">';
							echo $getNewSongs[$i][2];
							echo '<div class="card-suggestion"><img src="misc/img/album-covers/'.$stringa[0].'" /></div>';
							echo '</a>';
						}
						?>
						</div>
					</div>-->

			</div>
		</div>
	</main>
	<footer class="footer-main">
		<?php
			include("misc/include/footer.html");
		?>
	</footer>
	<button onclick="topFunction()" id="button-top" title="Go to top">Top</button>
	<script src="misc/js/button-top.js"></script>
</body>

</html>
